/*! puppet.js version: 0.4.0
 * (c) 2013 Joachim Wester
 * MIT license
 */
!function(a){function b(a,b,c,d){this.puppet=a,c&&(this.onReceive=c),d&&(this.onSend=d),this.referer=null;var e=this;Object.defineProperty(this,"useWebSocket",{get:function(){return b},set:function(a){return 0==a&&e._ws&&(e._ws.onclose=function(){e._ws=null},e._ws.close()),b=a}}),this.handleResponseCookie()}function c(a){this.apply=a}function d(a){a||(a={}),this.debug=void 0!=a.debug?a.debug:!0,this.remoteUrl=a.remoteUrl,this.obj=a.obj||{},this.observer=null,this.onRemoteChange=a.onRemoteChange,this.onPatchReceived=a.onPatchReceived||function(){},this.onPatchSent=a.onPatchSent||function(){},this.network=new b(this,a.useWebSocket||!1,this.handleRemoteChange.bind(this),this.onPatchSent.bind(this)),Object.defineProperty(this,"useWebSocket",{get:function(){return this.network.useWebSocket},set:function(a){this.network.useWebSocket=a}}),this.queue=a.localVersionPath?a.remoteVersionPath?a.ot?new JSONPatchOTAgent(JSONPatchOT.transform,[a.localVersionPath,a.remoteVersionPath],this.validateAndApplySequence.bind(this),a.purity):new JSONPatchQueue([a.localVersionPath,a.remoteVersionPath],this.validateAndApplySequence.bind(this),a.purity):new JSONPatchQueueSynchronous(a.localVersionPath,this.validateAndApplySequence.bind(this),a.purity):new c(this.validateAndApplySequence.bind(this)),this.ignoreCache=[],this.ignoreAdd=a.ignoreAdd||null;var d=a.callback,e=this;this.network.establish(this.remoteUrl,function(a){var b=JSON.parse(a);h(e.obj,b),e.debug&&(e.remoteObj=a),g(e,"obj"),e.observe(),d&&d.call(e,e.obj),k&&(document.body.removeEventListener("click",k),window.removeEventListener("popstate",l),window.removeEventListener("puppet-redirect-pushstate",m),document.body.removeEventListener("blur",n,!0)),document.body.addEventListener("click",k=e.clickHandler.bind(e)),window.addEventListener("popstate",l=e.historyHandler.bind(e)),window.addEventListener("puppet-redirect-pushstate",m=e.historyHandler.bind(e)),document.body.addEventListener("blur",n=e.clickAndBlurCallback.bind(e),!0),o||(o=e,e.fixShadowRootClicks())})}function e(a,b){var c=b.split("/"),d=c.length;if(c.length>2)for(var e=1;d-1>e;e++)a=a[c[e]];g(a,c[d-1])}function f(a,b){var c=a[b];null===c||"object"!=typeof c||c.hasOwnProperty("$parent")||Object.defineProperty(c,"$parent",{enumerable:!1,get:function(){return a}})}function g(a,b){f(a,b),a=a[b];for(var c in a)a.hasOwnProperty(c)&&"object"==typeof a[c]&&g(a,c)}function h(a,b){for(var c in b)b.hasOwnProperty(c)&&("object"==typeof b[c]&&a.hasOwnProperty(c)?h(a[c],b[c]):a[c]=b[c])}function i(a,b,c,d){if("add"===d&&a.test(c))return b[c]=!0,!0;for(var e=c.split("/"),f="",g=1,h=e.length;h>g;g++)if(f+="/"+e[g],b[f])return!0;return!1}var j=function(){};j.prototype={constructor:j,apply:function(a){a.addEventListener=j.prototype.addEventListener,a.hasEventListener=j.prototype.hasEventListener,a.removeEventListener=j.prototype.removeEventListener,a.dispatchEvent=j.prototype.dispatchEvent},addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;void 0===c[a]&&(c[a]=[]),-1===c[a].indexOf(b)&&c[a].push(b)},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var c=this._listeners;return void 0!==c[a]&&-1!==c[a].indexOf(b)?!0:!1},removeEventListener:function(a,b){if(void 0!==this._listeners){var c=this._listeners,d=c[a];if(void 0!==d){var e=d.indexOf(b);-1!==e&&d.splice(e,1)}}},dispatchEvent:function(a){if(void 0!==this._listeners){var b=this._listeners,c=b[a.type];if(void 0!==c){a.target=this;for(var d=[],e=c.length,f=0;e>f;f++)d[f]=c[f];for(var f=0;e>f;f++)d[f].call(this,a)}}}};var k,l,m,n,o;b.prototype.establish=function(a,b){var c=this;return this.xhr(a,"application/json",null,function(a){return b(a.responseText),c.useWebSocket&&c.webSocketUpgrade(),c})},b.prototype.send=function(a){var b=this;if(this.useWebSocket)if(this._ws)if(0===this._ws.readyState){var c=this._ws.onopen;this._ws.onopen=function(){c(),b._ws.send(a),b.onSend(a,b._ws.url)}}else this._ws.send(a),b.onSend(a,b._ws.url);else this.webSocketUpgrade(function(){b._ws.send(a),b.onSend(a,b._ws.url)});else{var d=this.referer||this.puppet.remoteUrl;this.xhr(d,"application/json-patch+json",a,function(a){b.onReceive(a.responseText,d)})}return this},b.prototype.onReceive=function(){},b.prototype.onSend=function(){},b.prototype.upgrade=function(){},b.prototype.webSocketUpgrade=function(a){var b=this,c=window.location.host,d=this.referer.replace(/__([^\/]*)\//g,"__$1/wsupgrade/"),e="ws://"+c+d;b._ws=new WebSocket(e),b._ws.onopen=function(b){a&&a(b)},b._ws.onmessage=function(a){b.onReceive(a.data,b._ws.url)},b._ws.onerror=function(a){b.puppet.showError("WebSocket connection could not be made",(a.data||"")+"\nCould not connect to: "+e)},b._ws.onclose=function(a){b.puppet.showError("WebSocket connection closed",a.code+" "+a.reason)}},b.prototype.changeState=function(a){var b=this;return this.xhr(a,"application/json-patch+json",null,function(c){b.onReceive(c.responseText,a)})},b.prototype.setReferer=function(a){this.referer&&this.referer!==a&&this.puppet.showError("Error: Session lost","Server replied with a different session ID that was already set. \nPossibly a server restart happened while you were working. \nPlease reload the page.\n\nPrevious session ID: "+this.referer+"\nNew session ID: "+a),this.referer=a},b.prototype.handleResponseHeader=function(a){var b=a.getResponseHeader("X-Location")||a.getResponseHeader("Location");b&&this.setReferer(b)},b.prototype.handleResponseCookie=function(){var a=p.read("Location");a&&(this.setReferer(a),p.erase("Location"))},b.prototype.xhr=function(a,b,c,d){p.erase("Location");var e=this,f=new XMLHttpRequest;return f.onload=function(){var a=this;e.handleResponseCookie(),e.handleResponseHeader(a),a.status>=400&&a.status<=599?e.puppet.showError("PuppetJs JSON response error","Server responded with error "+a.status+" "+a.statusText+"\n\n"+a.responseText):d&&d.call(e.puppet,a)},a=a||window.location.href,c?(f.open("PATCH",a,!0),f.setRequestHeader("Content-Type","application/json-patch+json")):f.open("GET",a,!0),b&&f.setRequestHeader("Accept",b),e.referer&&f.setRequestHeader("X-Referer",e.referer),e.onSend(c,a),f.send(c),f},c.prototype.send=function(a){return a},c.prototype.receive=function(a,b){this.apply(a,b)},d.prototype=Object.create(j.prototype),d.prototype.observe=function(){this.observer=jsonpatch.observe(this.obj,this.filterChangedCallback.bind(this))},d.prototype.unobserve=function(){this.observer&&(jsonpatch.unobserve(this.obj,this.observer),this.observer=null)},d.prototype.filterChangedCallback=function(a){this.filterIgnoredPatches(a),a.length&&("INPUT"!==document.activeElement.nodeName&&"TEXTAREA"!==document.activeElement.nodeName||"input"===document.activeElement.getAttribute("update-on"))&&(this.handleLocalChange(a),a.length=0)},d.prototype.clickAndBlurCallback=function(a){if(!a||a.target!==document.body&&"BODY"!==a.target.nodeName){var b=jsonpatch.generate(this.observer);b.length&&this.handleLocalChange(b)}},d.prototype.filterIgnoredPatches=function(a){if(this.ignoreAdd)for(var b=0,c=a.length;c>b;b++)i(this.ignoreAdd,this.ignoreCache,a[b].path,a[b].op)&&(a.splice(b,1),c--,b--);return a},d.prototype.handleLocalChange=function(a){var b=this;this.debug&&this.validateSequence(this.remoteObj,a);var c=JSON.stringify(this.queue.send(a));if(c.indexOf("__Jasmine_been_here_before__")>-1)throw new Error("PuppetJs did not handle Jasmine test case correctly");this.network.send(c),this.unobserve(),a.forEach(function(a){e(b.obj,a.path)}),this.observe()},d.prototype.validateAndApplySequence=function(a,b){if(this.debug)try{jsonpatch.apply(a,b,!0)}catch(c){c.message="Incoming patch validation error: "+c.message;var d;if(ErrorEvent.prototype.initErrorEvent){var d=document.createEvent("ErrorEvent");d.initErrorEvent("error",!0,!0,c.message,"",""),Object.defineProperty(d,"error",{value:c})}else d=new ErrorEvent("error",{bubbles:!0,cancelable:!0,error:c});this.dispatchEvent(d)}else jsonpatch.apply(a,b)},d.prototype.validateSequence=function(a,b){var c=jsonpatch.validate(b,a);if(c){c.message="Outgoing patch validation error: "+c.message;var d;if(ErrorEvent.prototype.initErrorEvent){var d=document.createEvent("ErrorEvent");d.initErrorEvent("error",!0,!0,c.message,"",""),Object.defineProperty(d,"error",{value:c})}else d=new ErrorEvent("error",{bubbles:!0,cancelable:!0,error:c});this.dispatchEvent(d)}},d.prototype.handleRemoteChange=function(a,b){var c=JSON.parse(a||"[]"),d=this;this.onPatchReceived&&this.onPatchReceived(a,b),this.observer&&(this.unobserve(),this.queue.receive(this.obj,c),c.forEach(function(a){if(""===a.path){var b=JSON.stringify(c);b.length>103&&(b=b.substring(0,100)+"..."),d.showWarning("Server pushed patch that replaces the object root",b)}("add"===a.op||"replace"===a.op||"test"===a.op)&&e(d.obj,a.path)}),this.observe(),this.onRemoteChange&&this.onRemoteChange(c),this.debug&&(this.remoteObj=JSON.parse(JSON.stringify(this.obj))))},d.prototype.clickHandler=function(a){a.detail&&a.detail.target&&(a=a.detail);var b=a.target;if(b.impl&&(b=b.impl),"A"!==b.nodeName){var c=q(b,"A");c&&(b=c)}var e=b.href||b.getAttribute("href");e&&d.isApplicationLink(e)?(a.preventDefault(),a.stopPropagation(),this.morphUrl(e)):"submit"===b.type?a.preventDefault():this.clickAndBlurCallback()},d.prototype.historyHandler=function(){this.network.changeState(location.href)},d.prototype.showWarning=function(b,c){this.debug&&a.console&&console.warn&&(c&&(b+=" ("+c+")"),console.warn("PuppetJs warning: "+b))},d.prototype.showError=function(a,b){if(this.debug){var c=document.getElementById("puppetjs-error");c||(c=document.createElement("DIV"),c.id="puppetjs-error",c.style.border="1px solid #dFb5b4",c.style.background="#fcf2f2",c.style.padding="10px 16px",c.style.position="fixed",c.style.top="0",c.style.left="0",c.style.zIndex="999",document.body.appendChild(c));var d=document.createElement("H1");d.innerHTML=a;var e=document.createElement("PRE");e.innerHTML=b,e.style.whiteSpace="pre-wrap",c.appendChild(d),c.appendChild(e)}throw new Error(b)},d.prototype.morphUrl=function(a){history.pushState(null,null,a),this.network.changeState(a)},d.prototype.findShadowRoots=function(a,b){b||(b=[]);for(var c=0,d=a.childNodes.length;d>c;c++)if(1===a.childNodes[c].nodeType){var e=a.childNodes[c].shadowRoot||a.childNodes[c].polymerShadowRoot_;e&&(b.push(e),this.findShadowRoots(e,b)),this.findShadowRoots(a.childNodes[c],b)}return b},d.prototype.fixShadowRootClicks=function(){for(var a=function(a){o&&o.clickHandler(a)},b=this.findShadowRoots(document.documentElement),c=0,d=b.length;d>c;c++)(b[c].impl||b[c]).addEventListener("click",a);var e=Element.prototype.createShadowRoot;Element.prototype.createShadowRoot=function(){var b=e.apply(this,arguments);return b.addEventListener("click",a),b}},d.isApplicationLink=function(a){if("string"==typeof a){var b=document.createElement("A");b.href=a,""==b.host&&(b.href=b.href),a=b}return a.protocol==window.location.protocol&&a.host==window.location.host};var p={create:function(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}document.cookie=a+"="+b+d+"; path=/"},readAll:function(){if(""===document.cookie)return{};for(var a=document.cookie.split("; "),b={},c=0,d=a.length;d>c;c++){var e=a[c].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b},read:function(a){return p.readAll()[a]},erase:function(a){p.create(a,"",-1)}},q=function(a){for(;null!=a;){if(1===a.nodeType&&(a.href||a.getAttribute("href")))return a;a=a.parentNode}return null};a.Puppet=d}(window);