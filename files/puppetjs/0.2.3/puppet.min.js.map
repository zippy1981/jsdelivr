{"version":3,"file":"puppet.min.js","sources":["src/puppet.js"],"names":["global","Puppet","remoteUrl","callback","obj","undefined","window","Promise","Error","this","debug","observer","referer","useWebSocket","localPatchQueue","handleResponseCookie","ignoreCache","ignoreAdd","cancelled","lastRequestPromise","xhr","bootstrap","bind","markObjPropertyByPath","path","keys","split","len","length","i","recursiveMarkObjProperties","placeMarkers","parent","key","subject","PuppetJsClickTrigger$","hasOwnProperty","Object","defineProperty","enumerable","get","recursiveExtend","par","lastClickHandler","lastPopstateHandler","lastBlurHandler","lastPuppet","prototype","res","tmp","JSON","parse","responseText","observe","document","body","removeEventListener","addEventListener","clickHandler","historyHandler","sendLocalChange","fixShadowRootClicks","webSocketUpgrade","that","host","location","wsPath","replace","upgradeURL","resolve","reject","_ws","WebSocket","onopen","event","onmessage","patches","data","handleRemoteChange","webSocketSendResolve","onerror","showError","onclose","code","reason","handleResponseHeader","getResponseHeader","setReferer","cookie","read","erase","jsonpatch","queueLocalChange","unobserve","Array","push","apply","activeElement","nodeName","getAttribute","flattenPatches","handleLocalChange","ev","target","generate","isIgnored","op","test","arr","joined","ilen","seen","splice","txt","stringify","indexOf","then","webSocketSend","forEach","patch","value","desc","substring","showWarning","onRemoteChange","changeState","href","detail","impl","parentA","closestHrefParent","isApplicationLink","preventDefault","stopPropagation","morphUrl","type","heading","description","console","warn","DIV","getElementById","createElement","id","style","border","background","padding","position","top","left","zIndex","appendChild","H1","innerHTML","PRE","whiteSpace","url","accept","beforeSend","error","req","XMLHttpRequest","onload","status","statusText","call","open","setRequestHeader","send","history","pushState","findShadowRoots","el","out","childNodes","nodeType","shadowRoot","polymerShadowRoot_","shadowRoots","documentElement","old","Element","createShadowRoot","arguments","elem","parser","protocol","create","name","days","expires","date","Date","setTime","getTime","toGMTString","readAll","cookies","result","l","item","decodeURIComponent","parentNode"],"mappings":";;;;CAKA,SAAWA,GAYT,QAASC,GAAOC,EAAWC,EAAUC,GACnC,GAAuBC,SAAnBC,OAAOC,QACT,KAAM,IAAIC,OAAM,0JAGlBC,MAAKC,OAAQ,EACbD,KAAKP,UAAYA,EACjBO,KAAKN,SAAWA,EAChBM,KAAKL,IAAMA,MACXK,KAAKE,SAAW,KAChBF,KAAKG,QAAU,KACfH,KAAKI,cAAe,EACpBJ,KAAKK,mBACLL,KAAKM,uBAELN,KAAKO,eACLP,KAAKQ,UAAY,KAQjBR,KAAKS,WAAY,EACjBT,KAAKU,mBAAqBV,KAAKW,IAAIX,KAAKP,UAAW,mBAAoB,KAAMO,KAAKY,UAAUC,KAAKb,OAenG,QAASc,GAAsBnB,EAAKoB,GAClC,GAAIC,GAAOD,EAAKE,MAAM,KAClBC,EAAMF,EAAKG,MACf,IAAIH,EAAKG,OAAS,EAChB,IAAK,GAAIC,GAAI,EAAOF,EAAM,EAAVE,EAAaA,IAC3BzB,EAAMA,EAAIqB,EAAKI,GAGnBC,GAA2B1B,EAAKqB,EAAKE,EAAM,IAG7C,QAASI,GAAaC,EAAQC,GAC5B,GAAIC,GAAUF,EAAOC,EACL,QAAZC,EACFF,EAAOC,GAAOE,EAEY,gBAAZD,IAAyBA,EAAQE,eAAe,YAC9DC,OAAOC,eAAeJ,EAAS,WAC7BK,YAAY,EACZC,IAAK,WACH,MAAOR,MAMf,QAASF,GAA2BE,EAAQC,GAC1CF,EAAaC,EAAQC,GACrBD,EAASA,EAAOC,EAChB,KAAK,GAAIJ,KAAKG,GACRA,EAAOI,eAAeP,IAA2B,gBAAdG,GAAOH,IAC5CC,EAA2BE,EAAQH,GAKzC,QAASY,GAAgBC,EAAKtC,GAC5B,IAAK,GAAIyB,KAAKzB,GACRA,EAAIgC,eAAeP,KACC,gBAAXzB,GAAIyB,IAAmBa,EAAIN,eAAeP,GACnDY,EAAgBC,EAAIb,GAAIzB,EAAIyB,IAG5Ba,EAAIb,GAAKzB,EAAIyB,IA9FrB,GAAIc,GACAC,EACAC,EACAC,EA8CAX,EAAwB,GAuD5BlC,GAAO8C,UAAU1B,UAAY,SAAU2B,GACrC,GAAIC,GAAMC,KAAKC,MAAMH,EAAII,aAsBzB,OArBAX,GAAgBhC,KAAKL,IAAK6C,GAE1BnB,EAA2BrB,KAAM,OACjCA,KAAK4C,UACD5C,KAAKN,UACPM,KAAKN,SAASM,KAAKL,KAEjBuC,IACFW,SAASC,KAAKC,oBAAoB,QAASb,GAC3CrC,OAAOkD,oBAAoB,WAAYZ,GACvCU,SAASC,KAAKC,oBAAoB,OAAQX,GAAiB,IAE7DS,SAASC,KAAKE,iBAAiB,QAASd,EAAmBlC,KAAKiD,aAAapC,KAAKb,OAClFH,OAAOmD,iBAAiB,WAAYb,EAAsBnC,KAAKkD,eAAerC,KAAKb,OACnF6C,SAASC,KAAKE,iBAAiB,OAAQZ,EAAkBpC,KAAKmD,gBAAgBtC,KAAKb,OAAO,GAErFqC,IACHA,EAAarC,KACbA,KAAKoD,uBAGApD,KAAKI,aAAeJ,KAAKqD,oBAAqB,GASvD7D,EAAO8C,UAAUe,iBAAmB,WAClC,GAAIC,GAAOtD,KACPuD,EAAO1D,OAAO2D,SAASD,KACvBE,EAASzD,KAAKG,QAAQuD,QAAQ,gBAAiB,mBAC/CC,EAAa,QAAUJ,EAAOE,CAClC,OAAO,IAAI3D,SAAQ,SAAU8D,EAASC,GACpCP,EAAKQ,IAAM,GAAIC,WAAUJ,GACzBL,EAAKQ,IAAIE,OAAS,SAAUC,GAC1BL,EAASK,IAEXX,EAAKQ,IAAII,UAAY,SAAUD,GAC7B,GAAIE,GAAU1B,KAAKC,MAAMuB,EAAMG,KAC/Bd,GAAKe,mBAAmBF,GACxBb,EAAKgB,qBAAsBL,IAE7BX,EAAKQ,IAAIS,QAAU,SAAUN,GAC3BX,EAAKkB,UAAU,0CAA2CP,EAAMG,MAAQ,IAAM,2BAA6BT,GAC3GE,EAAQI,IAEVX,EAAKQ,IAAIW,QAAU,SAAUR,GAC3BX,EAAKkB,UAAU,8BAA+BP,EAAMS,KAAO,IAAMT,EAAMU,YAK7EnF,EAAO8C,UAAUsC,qBAAuB,SAAUjE,GAChD,GAAI6C,GAAW7C,EAAIkE,kBAAkB,eAAiBlE,EAAIkE,kBAAkB,WACxErB,IACFxD,KAAK8E,WAAWtB,IAWpBhE,EAAO8C,UAAUhC,qBAAuB,WACtC,GAAIkD,GAAWuB,EAAOC,KAAK,WACvBxB,KACFxD,KAAK8E,WAAWtB,GAChBuB,EAAOE,MAAM,cAIjBzF,EAAO8C,UAAUwC,WAAa,SAAU3E,GAClCH,KAAKG,SAAWH,KAAKG,UAAYA,GACnCH,KAAKwE,UAAU,sBAAuB,mLAAqLxE,KAAKG,QAAU,qBAAuBA,GAEnQH,KAAKG,QAAUA,GAGjBX,EAAO8C,UAAUM,QAAU,WACzB5C,KAAKS,WAAY,EACjBT,KAAKE,SAAWgF,UAAUtC,QAAQ5C,KAAKL,IAAKK,KAAKmF,iBAAiBtE,KAAKb,QAGzER,EAAO8C,UAAU8C,UAAY,WAC3BpF,KAAKS,WAAY,EACbT,KAAKE,WACPgF,UAAUE,UAAUpF,KAAKL,IAAKK,KAAKE,UACnCF,KAAKE,SAAW,OAIpBV,EAAO8C,UAAU6C,iBAAmB,SAAUhB,GAC5CkB,MAAM/C,UAAUgD,KAAKC,MAAMvF,KAAKK,gBAAiB8D,IACR,UAApCtB,SAAS2C,cAAcC,UAA4D,aAApC5C,SAAS2C,cAAcC,UAAiF,UAArD5C,SAAS2C,cAAcE,aAAa,gBACzI1F,KAAK2F,eAAe3F,KAAKK,iBACrBL,KAAKK,gBAAgBc,SACvBnB,KAAK4F,kBAAkB5F,KAAKK,iBAC5BL,KAAKK,gBAAgBc,OAAS,KAKpC3B,EAAO8C,UAAUa,gBAAkB,SAAU0C,KACvCA,GAAOA,EAAGC,SAAWjD,SAASC,MAA+B,SAAvB+C,EAAGC,OAAOL,YAGpDP,UAAUa,SAAS/F,KAAKE,UACxBF,KAAK2F,eAAe3F,KAAKK,iBACrBL,KAAKK,gBAAgBc,SACvBnB,KAAK4F,kBAAkB5F,KAAKK,iBAC5BL,KAAKK,gBAAgBc,OAAS,KAIlC3B,EAAO8C,UAAU0D,UAAY,SAAUjF,EAAMkF,GAC3C,GAAIjG,KAAKQ,UAAW,CAClB,GAAW,QAAPyF,GAAgBjG,KAAKQ,UAAU0F,KAAKnF,GAEtC,MADAf,MAAKO,YAAYQ,IAAQ,GAClB,CAIT,KAAK,GAFDoF,GAAMpF,EAAKE,MAAM,KACjBmF,EAAS,GACJhF,EAAI,EAAGiF,EAAOF,EAAIhF,OAAYkF,EAAJjF,EAAUA,IAE3C,GADAgF,GAAU,IAAMD,EAAI/E,GAChBpB,KAAKO,YAAY6F,GACnB,OAAO,EAIb,OAAO,GAIT5G,EAAO8C,UAAUqD,eAAiB,SAAUxB,GAE1C,IAAK,GADDmC,MACKlF,EAAI,EAAGiF,EAAOlC,EAAQhD,OAAYkF,EAAJjF,EAAUA,IAC3CpB,KAAKgG,UAAU7B,EAAQ/C,GAAGL,KAAMoD,EAAQ/C,GAAG6E,KAC7C9B,EAAQoC,OAAOnF,EAAG,GAClBiF,IACAjF,KAEyB,YAAlB+C,EAAQ/C,GAAG6E,KACYrG,SAA1B0G,EAAKnC,EAAQ/C,GAAGL,OAClBoD,EAAQmC,EAAKnC,EAAQ/C,GAAGL,OAASoD,EAAQ/C,GACzC+C,EAAQoC,OAAOnF,EAAG,GAClBiF,IACAjF,KAGAkF,EAAKnC,EAAQ/C,GAAGL,MAAQK,IAMhC5B,EAAO8C,UAAUsD,kBAAoB,SAAUzB,GAC7C,GAAIb,GAAOtD,KACPwG,EAAM/D,KAAKgE,UAAUtC,EACzB,IAAIqC,EAAIE,QAAQ,gCAAkC,GAChD,KAAM,IAAI3G,OAAM,sDAGhBC,MAAKU,mBAAqBV,KAAKU,mBAAmBiG,KADhD3G,KAAKI,aACiDJ,KAAK4G,cAAc/F,KAAKb,KAAKwG,GAI9B,WACrD,MAAOlD,GAAK3C,IAAI2C,EAAKnD,SAAWmD,EAAK7D,UAAW,8BAA+B+G,EAAK,SAAUjE,GAC5F,GAAI4B,GAAU1B,KAAKC,MAAMH,EAAII,cAAgB,KAC7CW,GAAKe,mBAAmBF,OAI9BnE,KAAKoF,YACLjB,EAAQ0C,QAAQ,SAAUC,GACN,QAAbA,EAAMb,IAA6B,YAAba,EAAMb,IAAiC,SAAba,EAAMb,IAAkC,OAAhBa,EAAMC,QACjFD,EAAMC,MAAQrF,EACdwD,UAAUK,MAAMjC,EAAK3D,KAAMmH,KAE7BhG,EAAsBwC,EAAK3D,IAAKmH,EAAM/F,QAExCf,KAAK4C,WAGPpD,EAAO8C,UAAU+B,mBAAqB,SAAUF,GAC9C,GAAKnE,KAAKE,SAAV,CAGA,GAAuB,SAAnBiE,EAAQhD,OACV,KAAM,IAAIpB,OAAM,6BAElBC,MAAKoF,YACLF,UAAUK,MAAMvF,KAAKL,IAAKwE,EAC1B,IAAIb,GAAOtD,IACXmE,GAAQ0C,QAAQ,SAAUC,GACxB,GAAmB,MAAfA,EAAM/F,KAAc,CACtB,GAAIiG,GAAOvE,KAAKgE,UAAUtC,EACtB6C,GAAK7F,OAAS,MAChB6F,EAAOA,EAAKC,UAAU,EAAG,KAAO,OAElC3D,EAAK4D,YAAY,oDAAqDF,IAEvD,QAAbF,EAAMb,IAA6B,YAAba,EAAMb,IAAiC,SAAba,EAAMb,KACxDnF,EAAsBwC,EAAK3D,IAAKmH,EAAM/F,QAG1Cf,KAAK4C,UACD5C,KAAKmH,gBACPnH,KAAKmH,eAAehD,KAIxB3E,EAAO8C,UAAU8E,YAAc,SAAUC,GACvC,GAAI/D,GAAOtD,IACXA,MAAKU,mBAAqBV,KAAKU,mBAAmBiG,KAAK,WACrD,MAAOrD,GAAK3C,IAAI0G,EAAM,8BAA+B,KAAM,SAAU9E,GACnE,GAAI4B,GAAU1B,KAAKC,MAAMH,EAAII,cAAgB,KAC7CW,GAAKe,mBAAmBF,QAK9B3E,EAAO8C,UAAUW,aAAe,SAAUgB,GACpCA,EAAMqD,QAAUrD,EAAMqD,OAAOxB,SAE/B7B,EAAQA,EAAMqD,OAEhB,IAAIxB,GAAS7B,EAAM6B,MAMnB,IALIA,EAAOyB,OAETzB,EAASA,EAAOyB,MAGM,MAApBzB,EAAOL,SAAkB,CAC3B,GAAI+B,GAAUC,EAAkB3B,EAAQ,IACpC0B,KACF1B,EAAS0B,GAOb,GAAIH,GAAOvB,EAAOuB,MAAQvB,EAAOJ,aAAa,OAE1C2B,IAAQ7H,EAAOkI,kBAAkBL,IACnCpD,EAAM0D,iBACN1D,EAAM2D,kBACN5H,KAAK6H,SAASR,IAES,WAAhBvB,EAAOgC,KACd7D,EAAM0D,iBAGN3H,KAAKmD,mBAIT3D,EAAO8C,UAAUY,eAAiB,WAChClD,KAAKoH,YAAY5D,SAAS6D,OAG5B7H,EAAO8C,UAAU4E,YAAc,SAAUa,EAASC,GAC5ChI,KAAKC,OAASV,EAAO0I,SAAWA,QAAQC,OACtCF,IACFD,GAAW,KAAOC,EAAc,KAElCC,QAAQC,KAAK,qBAAuBH,KAIxCvI,EAAO8C,UAAUkC,UAAY,SAAUuD,EAASC,GAC9C,GAAIhI,KAAKC,MAAO,CACd,GAAIkI,GAAMtF,SAASuF,eAAe,iBAC7BD,KACHA,EAAMtF,SAASwF,cAAc,OAC7BF,EAAIG,GAAK,iBACTH,EAAII,MAAMC,OAAS,oBACnBL,EAAII,MAAME,WAAa,UACvBN,EAAII,MAAMG,QAAU,YACpBP,EAAII,MAAMI,SAAW,WACrBR,EAAII,MAAMK,IAAM,IAChBT,EAAII,MAAMM,KAAO,IACjBV,EAAII,MAAMO,OAAS,MACnBjG,SAASC,KAAKiG,YAAYZ,GAG5B,IAAIa,GAAKnG,SAASwF,cAAc,KAChCW,GAAGC,UAAYlB,CAEf,IAAImB,GAAMrG,SAASwF,cAAc,MACjCa,GAAID,UAAYjB,EAChBkB,EAAIX,MAAMY,WAAa,WAEvBhB,EAAIY,YAAYC,GAChBb,EAAIY,YAAYG,GAElB,KAAM,IAAInJ,OAAMiI,IAYlBxI,EAAO8C,UAAU3B,IAAM,SAAUyI,EAAKC,EAAQjF,EAAM1E,EAAU4J,GAE5DvE,EAAOE,MAAM,WACb,IAAI3B,GAAOtD,IACX,OAAO,IAAIF,SAAQ,SAAU8D,EAASC,GACpC,GAAIP,EAAK7C,UAGP,MAFAwH,SAAQsB,MAAM,8CACd1F,IAGF,IAAI2F,GAAM,GAAIC,eACdD,GAAIE,OAAS,WACX,GAAInH,GAAMvC,IACVsD,GAAKhD,uBACLgD,EAAKsB,qBAAqBrC,GACtBA,EAAIoH,QAAU,KAAOpH,EAAIoH,QAAU,KACrCrG,EAAKkB,UAAU,+BAAgC,+BAAiCjC,EAAIoH,OAAS,IAAMpH,EAAIqH,WAAa,OAASrH,EAAII,cACjIkB,KAGAD,EAASlE,GAAYA,EAASmK,KAAKvG,EAAMf,IAAQA,IAGrD6G,EAAMA,GAAOvJ,OAAO2D,SAAS6D,KACzBjD,GACFoF,EAAIM,KAAK,QAASV,GAAK,GACvBI,EAAIO,iBAAiB,eAAgB,gCAGrCP,EAAIM,KAAK,MAAOV,GAAK,GAEnBC,GACFG,EAAIO,iBAAiB,SAAUV,GAE7B/F,EAAKnD,SACPqJ,EAAIO,iBAAiB,YAAazG,EAAKnD,SAErCmJ,GACFA,EAAWO,KAAKvG,EAAMkG,GAExBA,EAAIQ,KAAK5F,MAUb5E,EAAO8C,UAAUsE,cAAgB,SAAUxC,GACzC,GAAId,GAAOtD,IACX,OAAO,IAAIF,SAAQ,SAAU8D,GAC3BN,EAAKgB,qBAAuBV,EAC5BN,EAAKQ,IAAIkG,KAAK5F,MASlB5E,EAAO8C,UAAUuF,SAAW,SAAUuB,GACpCa,QAAQC,UAAU,KAAM,KAAMd,GAC9BpJ,KAAKoH,YAAYgC,IAQnB5J,EAAO8C,UAAU6H,gBAAkB,SAAUC,EAAIC,GAC1CA,IACHA,KAEF,KAAK,GAAIjJ,GAAI,EAAGiF,EAAO+D,EAAGE,WAAWnJ,OAAYkF,EAAJjF,EAAUA,IACrD,GAAkC,IAA9BgJ,EAAGE,WAAWlJ,GAAGmJ,SAAgB,CACnC,GAAIC,GAAaJ,EAAGE,WAAWlJ,GAAGoJ,YAAcJ,EAAGE,WAAWlJ,GAAGqJ,kBAC7DD,KACFH,EAAI/E,KAAKkF,GACTxK,KAAKmK,gBAAgBK,EAAYH,IAEnCrK,KAAKmK,gBAAgBC,EAAGE,WAAWlJ,GAAIiJ,GAG3C,MAAOA,IAOT7K,EAAO8C,UAAUc,oBAAsB,WASrC,IAAK,GARDH,GAAe,SAAUgB,GACvB5B,GACFA,EAAWY,aAAagB,IAKxByG,EAAc1K,KAAKmK,gBAAgBtH,SAAS8H,iBACvCvJ,EAAI,EAAGiF,EAAOqE,EAAYvJ,OAAYkF,EAAJjF,EAAUA,KAClDsJ,EAAYtJ,GAAGmG,MAAQmD,EAAYtJ,IAAI4B,iBAAiB,QAASC,EAIpE,IAAI2H,GAAMC,QAAQvI,UAAUwI,gBAC5BD,SAAQvI,UAAUwI,iBAAmB,WACnC,GAAIN,GAAaI,EAAIrF,MAAMvF,KAAM+K,UAEjC,OADAP,GAAWxH,iBAAiB,QAASC,GAC9BuH,IASXhL,EAAOkI,kBAAoB,SAAUsD,GACnC,GAAoB,gBAATA,GAAmB,CAE5B,GAAIC,GAASpI,SAASwF,cAAc,IACpC4C,GAAO5D,KAAO2D,EAMK,IAAfC,EAAO1H,OACT0H,EAAO5D,KAAO4D,EAAO5D,MAGvB2D,EAAOC,EAET,MAAQD,GAAKE,UAAYrL,OAAO2D,SAAS0H,UAAYF,EAAKzH,MAAQ1D,OAAO2D,SAASD,KASpF,IAAIwB,IACFoG,OAAQ,SAAsBC,EAAMrE,EAAOsE,GACzC,GAAIC,GAAU,EACd,IAAID,EAAM,CACR,GAAIE,GAAO,GAAIC,KACfD,GAAKE,QAAQF,EAAKG,UAAoB,GAAPL,EAAY,GAAK,GAAK,KACrDC,EAAU,aAAeC,EAAKI,cAEhC9I,SAASkC,OAASqG,EAAO,IAAMrE,EAAQuE,EAAU,YAGnDM,QAAS,WACP,GAAwB,KAApB/I,SAASkC,OAAe,QAG5B,KAAK,GAFD8G,GAAUhJ,SAASkC,OAAO9D,MAAM,MAChC6K,KACK1K,EAAI,EAAG2K,EAAIF,EAAQ1K,OAAY4K,EAAJ3K,EAAOA,IAAK,CAC9C,GAAI4K,GAAOH,EAAQzK,GAAGH,MAAM,IAC5B6K,GAAOG,mBAAmBD,EAAK,KAAOC,mBAAmBD,EAAK,IAEhE,MAAOF,IAGT9G,KAAM,SAAoBoG,GACxB,MAAOrG,GAAO6G,UAAUR,IAG1BnG,MAAO,SAAqBmG,GAC1BrG,EAAOoG,OAAOC,EAAM,GAAI,MAKxB3D,EAAoB,SAAUuD,GAChC,KAAe,MAARA,GAAc,CACnB,GAAsB,IAAlBA,EAAKT,WAAmBS,EAAK3D,MAAQ2D,EAAKtF,aAAa,SACzD,MAAOsF,EAETA,GAAOA,EAAKkB,WAEd,MAAO,MAGT3M,GAAOC,OAASA,GACfK","sourcesContent":["/*! puppet.js 0.2.3\n * (c) 2013 Joachim Wester\n * MIT license\n */\n\n(function (global) {\n  var lastClickHandler\n    , lastPopstateHandler\n    , lastBlurHandler\n    , lastPuppet;\n\n  /**\n   * Defines a connection to a remote PATCH server, returns callback to a object that is persistent between browser and server\n   * @param remoteUrl If undefined, current window.location.href will be used as the PATCH server URL\n   * @param callback Called after initial state object is received from the server\n   * @param obj Optional object where the parsed JSON data will be inserted\n   */\n  function Puppet(remoteUrl, callback, obj) {\n    if (window.Promise === undefined) {\n      throw new Error(\"Promise API not available. If you are using an outdated browser, make sure to load a Promise/A+ shim, e.g. https://github.com/jakearchibald/es6-promise\");\n    }\n\n    this.debug = true;\n    this.remoteUrl = remoteUrl;\n    this.callback = callback;\n    this.obj = obj || {};\n    this.observer = null;\n    this.referer = null;\n    this.useWebSocket = false; //change to TRUE to enable WebSocket connection\n    this.localPatchQueue = [];\n    this.handleResponseCookie();\n\n    this.ignoreCache = [];\n    this.ignoreAdd = null; //undefined, null or regexp (tested against JSON Pointer in JSON Patch)\n\n    //usage:\n    //puppet.ignoreAdd = null;  //undefined or null means that all properties added on client will be sent to server\n    //puppet.ignoreAdd = /./; //ignore all the \"add\" operations\n    //puppet.ignoreAdd = /\\/\\$.+/; //ignore the \"add\" operations of properties that start with $\n    //puppet.ignoreAdd = /\\/_.+/; //ignore the \"add\" operations of properties that start with _\n\n    this.cancelled = false;\n    this.lastRequestPromise = this.xhr(this.remoteUrl, 'application/json', null, this.bootstrap.bind(this));\n  }\n\n  /**\n   * PuppetJsClickTrigger$ contains Unicode symbols for \"NULL\" text rendered stylized using Unicode\n   * character \"SYMBOL FOR NULL\" (2400)\n   *\n   * With PuppetJs, any property having `null` value will be rendered as stylized \"NULL\" text\n   * to emphasize that it probably should be set as empty string instead.\n   *\n   * The benefit of having this string is that any local change to `null` value (also\n   * from `null` to `null`) can be detected and sent as `null` to the server.\n   */\n  var PuppetJsClickTrigger$ = \"\\u2400\";\n\n  function markObjPropertyByPath(obj, path) {\n    var keys = path.split('/');\n    var len = keys.length;\n    if (keys.length > 2) {\n      for (var i = 1; i < len - 1; i++) {\n        obj = obj[keys[i]];\n      }\n    }\n    recursiveMarkObjProperties(obj, keys[len - 1]);\n  }\n\n  function placeMarkers(parent, key) {\n    var subject = parent[key];\n    if (subject === null) {\n      parent[key] = PuppetJsClickTrigger$;\n    }\n    else if (typeof subject === 'object' && !subject.hasOwnProperty('$parent')) {\n      Object.defineProperty(subject, '$parent', {\n        enumerable: false,\n        get: function () {\n          return parent;\n        }\n      });\n    }\n  }\n\n  function recursiveMarkObjProperties(parent, key) {\n    placeMarkers(parent, key);\n    parent = parent[key];\n    for (var i in parent) {\n      if (parent.hasOwnProperty(i) && typeof parent[i] === 'object') {\n        recursiveMarkObjProperties(parent, i);\n      }\n    }\n  }\n\n  function recursiveExtend(par, obj) {\n    for (var i in obj) {\n      if (obj.hasOwnProperty(i)) {\n        if (typeof obj[i] === 'object' && par.hasOwnProperty(i)) {\n          recursiveExtend(par[i], obj[i]);\n        }\n        else {\n          par[i] = obj[i];\n        }\n      }\n    }\n  }\n  /**\n   * [bootstrap description]\n   * @param  {[type]} res [description]\n   * @return {Promise || true}     Promise for #webSocketUpgrade or just `true` is websockets disabled.\n   */\n  Puppet.prototype.bootstrap = function (res) {\n    var tmp = JSON.parse(res.responseText);\n    recursiveExtend(this.obj, tmp);\n\n    recursiveMarkObjProperties(this, \"obj\");\n    this.observe();\n    if (this.callback) {\n      this.callback(this.obj);\n    }\n    if (lastClickHandler) {\n      document.body.removeEventListener('click', lastClickHandler);\n      window.removeEventListener('popstate', lastPopstateHandler);\n      document.body.removeEventListener('blur', lastBlurHandler, true);\n    }\n    document.body.addEventListener('click', lastClickHandler = this.clickHandler.bind(this));\n    window.addEventListener('popstate', lastPopstateHandler = this.historyHandler.bind(this)); //better here than in constructor, because Chrome triggers popstate on page load\n    document.body.addEventListener('blur', lastBlurHandler = this.sendLocalChange.bind(this), true);\n\n    if (!lastPuppet) {\n      lastPuppet = this;\n      this.fixShadowRootClicks();\n    }\n\n    return this.useWebSocket ? this.webSocketUpgrade() : true ;\n  };\n\n  /**\n   * Send a WebSocket upgrade request to the server.\n   * For testing purposes WS upgrade url is hardcoded now in PuppetJS (replace __default/ID with __default/wsupgrade/ID)\n   * In future, server should suggest the WebSocket upgrade URL\n   * @returns {Promise} that WS get opened, resolves/rejects with WS event [description]\n   */\n  Puppet.prototype.webSocketUpgrade = function () {\n    var that = this;\n    var host = window.location.host;\n    var wsPath = this.referer.replace(/__([^\\/]*)\\//g, \"__$1/wsupgrade/\");\n    var upgradeURL = \"ws://\" + host + wsPath;\n    return new Promise(function (resolve, reject) {\n      that._ws = new WebSocket(upgradeURL);\n      that._ws.onopen = function (event) {\n        resolve( event );\n      };\n      that._ws.onmessage = function (event) {\n        var patches = JSON.parse(event.data);\n        that.handleRemoteChange(patches);\n        that.webSocketSendResolve( event );\n      };\n      that._ws.onerror = function (event) {\n        that.showError(\"WebSocket connection could not be made\", (event.data || \"\") + \"\\nCould not connect to: \" + upgradeURL);\n        reject( event );\n      };\n      that._ws.onclose = function (event) {\n        that.showError(\"WebSocket connection closed\", event.code + \" \" + event.reason);\n      };\n    });\n  };\n\n  Puppet.prototype.handleResponseHeader = function (xhr) {\n    var location = xhr.getResponseHeader('X-Location') || xhr.getResponseHeader('Location');\n    if (location) {\n      this.setReferer(location);\n    }\n  };\n\n  /**\n   * PuppetJs does not use cookies because of sessions (you need to take care of it in your application code)\n   * Reason PuppetJs handles cookies is different:\n   * JavaScript cannot read HTTP \"Location\" header for the main HTML document, but it can read cookies\n   * So if you want to establish session in the main HTML document, send \"Location\" value as a cookie\n   * The cookie will be erased (replaced with empty value) after reading\n   */\n  Puppet.prototype.handleResponseCookie = function () {\n    var location = cookie.read('Location');\n    if (location) { //if cookie exists and is not empty\n      this.setReferer(location);\n      cookie.erase('Location');\n    }\n  };\n\n  Puppet.prototype.setReferer = function (referer) {\n    if (this.referer && this.referer !== referer) {\n      this.showError(\"Error: Session lost\", \"Server replied with a different session ID that was already set. \\nPossibly a server restart happened while you were working. \\nPlease reload the page.\\n\\nPrevious session ID: \" + this.referer + \"\\nNew session ID: \" + referer);\n    }\n    this.referer = referer;\n  };\n\n  Puppet.prototype.observe = function () {\n    this.cancelled = false;\n    this.observer = jsonpatch.observe(this.obj, this.queueLocalChange.bind(this));\n  };\n\n  Puppet.prototype.unobserve = function () {\n    this.cancelled = true;\n    if (this.observer) { //there is a bug in JSON-Patch when trying to unobserve something that is already unobserved\n      jsonpatch.unobserve(this.obj, this.observer);\n      this.observer = null;\n    }\n  };\n\n  Puppet.prototype.queueLocalChange = function (patches) {\n    Array.prototype.push.apply(this.localPatchQueue, patches);\n    if ((document.activeElement.nodeName !== 'INPUT' && document.activeElement.nodeName !== 'TEXTAREA') || document.activeElement.getAttribute('update-on') === 'input') {\n      this.flattenPatches(this.localPatchQueue);\n      if (this.localPatchQueue.length) {\n        this.handleLocalChange(this.localPatchQueue);\n        this.localPatchQueue.length = 0;\n      }\n    }\n  };\n\n  Puppet.prototype.sendLocalChange = function (ev) {\n    if (ev && (ev.target === document.body || ev.target.nodeName === \"BODY\")) { //Polymer warps ev.target so it is not exactly document.body\n      return; //IE triggers blur event on document.body. This is not what we need\n    }\n    jsonpatch.generate(this.observer);\n    this.flattenPatches(this.localPatchQueue);\n    if (this.localPatchQueue.length) {\n      this.handleLocalChange(this.localPatchQueue);\n      this.localPatchQueue.length = 0;\n    }\n  };\n\n  Puppet.prototype.isIgnored = function (path, op) {\n    if (this.ignoreAdd) {\n      if (op === 'add' && this.ignoreAdd.test(path)) {\n        this.ignoreCache[path] = true;\n        return true;\n      }\n      var arr = path.split('/');\n      var joined = '';\n      for (var i = 1, ilen = arr.length; i < ilen; i++) {\n        joined += '/' + arr[i];\n        if (this.ignoreCache[joined]) {\n          return true; //once we decided to ignore something that was added, other operations (replace, remove, ...) are ignored as well\n        }\n      }\n    }\n    return false;\n  };\n\n  //merges redundant patches and ignores private member changes\n  Puppet.prototype.flattenPatches = function (patches) {\n    var seen = {};\n    for (var i = 0, ilen = patches.length; i < ilen; i++) {\n      if (this.isIgnored(patches[i].path, patches[i].op)) { //if it is ignored, remove patch\n        patches.splice(i, 1); //ignore changes to properties that start with PRIVATE_PREFIX\n        ilen--;\n        i--;\n      }\n      else if (patches[i].op === 'replace') { //if it is already seen in the patches array, replace the previous instance\n        if (seen[patches[i].path] !== undefined) {\n          patches[seen[patches[i].path]] = patches[i];\n          patches.splice(i, 1);\n          ilen--;\n          i--;\n        }\n        else {\n          seen[patches[i].path] = i;\n        }\n      }\n    }\n  };\n\n  Puppet.prototype.handleLocalChange = function (patches) {\n    var that = this;\n    var txt = JSON.stringify(patches);\n    if (txt.indexOf('__Jasmine_been_here_before__') > -1) {\n      throw new Error(\"PuppetJs did not handle Jasmine test case correctly\");\n    }\n    if (this.useWebSocket) {\n      this.lastRequestPromise = this.lastRequestPromise.then( this.webSocketSend.bind(this,txt) );\n    }\n    else {\n      //\"referer\" should be used as the url when sending JSON Patches (see https://github.com/PuppetJs/PuppetJs/wiki/Server-communication)\n      this.lastRequestPromise = this.lastRequestPromise.then(function () {\n        return that.xhr(that.referer || that.remoteUrl, 'application/json-patch+json', txt, function (res) {\n          var patches = JSON.parse(res.responseText || '[]'); //fault tolerance - empty response string should be treated as empty patch array\n          that.handleRemoteChange(patches);\n        })\n      });\n    }\n    this.unobserve();\n    patches.forEach(function (patch) {\n      if ((patch.op === \"add\" || patch.op === \"replace\" || patch.op === \"test\") && patch.value === null) {\n        patch.value = PuppetJsClickTrigger$;\n        jsonpatch.apply(that.obj, [patch]);\n      }\n      markObjPropertyByPath(that.obj, patch.path);\n    });\n    this.observe();\n  };\n\n  Puppet.prototype.handleRemoteChange = function (patches) {\n    if (!this.observer) {\n      return; //ignore remote change if we are not watching anymore\n    }\n    if (patches.length === void 0) {\n      throw new Error(\"Patches should be an array\");\n    }\n    this.unobserve();\n    jsonpatch.apply(this.obj, patches);\n    var that = this;\n    patches.forEach(function (patch) {\n      if (patch.path === \"/\") {\n        var desc = JSON.stringify(patches);\n        if (desc.length > 103) {\n          desc = desc.substring(0, 100) + \"...\";\n        }\n        that.showWarning(\"Server pushed patch that replaces the object root\", desc);\n      }\n      if (patch.op === \"add\" || patch.op === \"replace\" || patch.op === \"test\") {\n        markObjPropertyByPath(that.obj, patch.path);\n      }\n    });\n    this.observe();\n    if (this.onRemoteChange) {\n      this.onRemoteChange(patches);\n    }\n  };\n\n  Puppet.prototype.changeState = function (href) {\n    var that = this;\n    this.lastRequestPromise = this.lastRequestPromise.then(function () {\n      return that.xhr(href, 'application/json-patch+json', null, function (res) {\n        var patches = JSON.parse(res.responseText || '[]'); //fault tolerance - empty response string should be treated as empty patch array\n        that.handleRemoteChange(patches);\n      })\n    });\n  };\n\n  Puppet.prototype.clickHandler = function (event) {\n    if (event.detail && event.detail.target) {\n      //detail is Polymer\n      event = event.detail;\n    }\n    var target = event.target;\n    if (target.impl) {\n      //impl is Polymer\n      target = target.impl;\n    }\n\n    if (target.nodeName !== 'A') {\n      var parentA = closestHrefParent(target, 'A');\n      if (parentA) {\n        target = parentA;\n      }\n    }\n\n    //needed since Polymer 0.2.0 in Chrome stable / Web Plaftorm features disabled\n    //because target.href returns undefined for <polymer-ui-menu-item href=\"...\"> (which is an error)\n    //while target.getAttribute(\"href\") returns desired href (as string)\n    var href = target.href || target.getAttribute(\"href\");\n\n    if (href && Puppet.isApplicationLink(href)) {\n      event.preventDefault();\n      event.stopPropagation();\n      this.morphUrl(href);\n    }\n    else if (target.type === 'submit') {\n      event.preventDefault();\n    }\n    else {\n      this.sendLocalChange(); //needed for checkbox\n    }\n  };\n\n  Puppet.prototype.historyHandler = function (/*event*/) {\n    this.changeState(location.href);\n  };\n\n  Puppet.prototype.showWarning = function (heading, description) {\n    if (this.debug && global.console && console.warn) {\n      if (description) {\n        heading += \" (\" + description + \")\";\n      }\n      console.warn(\"PuppetJs warning: \" + heading);\n    }\n  };\n\n  Puppet.prototype.showError = function (heading, description) {\n    if (this.debug) {\n      var DIV = document.getElementById('puppetjs-error');\n      if (!DIV) {\n        DIV = document.createElement('DIV');\n        DIV.id = 'puppetjs-error';\n        DIV.style.border = '1px solid #dFb5b4';\n        DIV.style.background = '#fcf2f2';\n        DIV.style.padding = '10px 16px';\n        DIV.style.position = 'absolute';\n        DIV.style.top = '0';\n        DIV.style.left = '0';\n        DIV.style.zIndex = '999';\n        document.body.appendChild(DIV);\n      }\n\n      var H1 = document.createElement('H1');\n      H1.innerHTML = heading;\n\n      var PRE = document.createElement('PRE');\n      PRE.innerHTML = description;\n      PRE.style.whiteSpace = 'pre-wrap';\n\n      DIV.appendChild(H1);\n      DIV.appendChild(PRE);\n    }\n    throw new Error(description);\n  };\n\n  /**\n   * Internal method to perform XMLHttpRequest\n   * @param url (Optional) URL to send the request. If empty string, undefined or null given - the request will be sent to window location\n   * @param accept (Optional) HTTP accept header\n   * @param data (Optional) Data payload\n   * @param callback (Optional) function\n   * @param beforeSend (Optional) Function that modifies the XHR object before the request is sent. Added for hackability\n   * @returns {Promise} Promise that XHR will be sent. Resolves with response, or callback's result for response (if callback given)\n   */\n  Puppet.prototype.xhr = function (url, accept, data, callback, beforeSend) {\n    //this.handleResponseCookie();\n    cookie.erase('Location'); //more invasive cookie erasing because sometimes the cookie was still visible in the requests\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      if (that.cancelled) {\n        console.error(\"PuppetJs: Promise cancelled on request\");\n        reject();\n        return;\n      }\n      var req = new XMLHttpRequest();\n      req.onload = function () {\n        var res = this;\n        that.handleResponseCookie();\n        that.handleResponseHeader(res);\n        if (res.status >= 400 && res.status <= 599) {\n          that.showError('PuppetJs JSON response error', 'Server responded with error ' + res.status + ' ' + res.statusText + '\\n\\n' + res.responseText);\n          reject();\n        }\n        else {\n          resolve( callback && callback.call(that, res) || res);\n        }\n      };\n      url = url || window.location.href;\n      if (data) {\n        req.open(\"PATCH\", url, true);\n        req.setRequestHeader('Content-Type', 'application/json-patch+json');\n      }\n      else {\n        req.open(\"GET\", url, true);\n      }\n      if (accept) {\n        req.setRequestHeader('Accept', accept);\n      }\n      if (that.referer) {\n        req.setRequestHeader('X-Referer', that.referer);\n      }\n      if (beforeSend) {\n        beforeSend.call(that, req);\n      }\n      req.send(data);\n    });\n  };\n\n  /**\n   * Internal method to perform WebSocket request that returns a promise which is resolved when the response comes\n   * @param data Data payload\n   * @returns {Promise} that data will be sent to WS, resolves with WS event\n   * @see #webSocketUpgrade\n   */\n  Puppet.prototype.webSocketSend = function (data) {\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      that.webSocketSendResolve = resolve;\n      that._ws.send(data);\n    });\n  };\n\n  /**\n   * Push a new URL to the browser address bar and send a patch request (empty or including queued local patches)\n   * so that the URL handlers can be executed on the server\n   * @param url\n   */\n  Puppet.prototype.morphUrl = function (url) {\n    history.pushState(null, null, url);\n    this.changeState(url);\n  };\n\n  /**\n   * Returns array of shadow roots inside of a element (recursive)\n   * @param el\n   * @param out (Optional)\n   */\n  Puppet.prototype.findShadowRoots = function (el, out) {\n    if (!out) {\n      out = [];\n    }\n    for (var i = 0, ilen = el.childNodes.length; i < ilen; i++) {\n      if (el.childNodes[i].nodeType === 1) {\n        var shadowRoot = el.childNodes[i].shadowRoot || el.childNodes[i].polymerShadowRoot_;\n        if (shadowRoot) {\n          out.push(shadowRoot);\n          this.findShadowRoots(shadowRoot, out);\n        }\n        this.findShadowRoots(el.childNodes[i], out);\n      }\n    }\n    return out;\n  };\n\n  /**\n   * Catches clicks in Shadow DOM\n   * @see <a href=\"https://groups.google.com/forum/#!topic/polymer-dev/fDRlCT7nNPU\">discussion</a>\n   */\n  Puppet.prototype.fixShadowRootClicks = function () {\n    var clickHandler = function (event) {\n      if (lastPuppet) {\n        lastPuppet.clickHandler(event);\n      }\n    };\n\n    //existing shadow roots\n    var shadowRoots = this.findShadowRoots(document.documentElement);\n    for (var i = 0, ilen = shadowRoots.length; i < ilen; i++) {\n      (shadowRoots[i].impl || shadowRoots[i]).addEventListener(\"click\", clickHandler);\n    }\n\n    //future shadow roots\n    var old = Element.prototype.createShadowRoot;\n    Element.prototype.createShadowRoot = function () {\n      var shadowRoot = old.apply(this, arguments);\n      shadowRoot.addEventListener(\"click\", clickHandler);\n      return shadowRoot;\n    }\n  };\n\n  /**\n   * Returns information if a given element is an internal application link that PuppetJS should intercept into a history push\n   * @param elem HTMLElement or String\n   * @returns {boolean}\n   */\n  Puppet.isApplicationLink = function (elem) {\n    if (typeof elem === 'string') {\n      //type string is reported in Polymer / Canary (Web Platform features disabled)\n      var parser = document.createElement('A');\n      parser.href = elem;\n\n      // @see http://stackoverflow.com/questions/736513/how-do-i-parse-a-url-into-hostname-and-path-in-javascript\n      // IE doesn't populate all link properties when setting .href with a relative URL,\n      // however .href will return an absolute URL which then can be used on itself\n      // to populate these additional fields.\n      if (parser.host == \"\") {\n        parser.href = parser.href;\n      }\n\n      elem = parser;\n    }\n    return (elem.protocol == window.location.protocol && elem.host == window.location.host);\n  };\n\n  /**\n   * Cookie helper\n   * @see Puppet.prototype.handleResponseCookie\n   * reference: http://www.quirksmode.org/js/cookies.html\n   * reference: https://github.com/js-coder/cookie.js/blob/gh-pages/cookie.js\n   */\n  var cookie = {\n    create: function createCookie(name, value, days) {\n      var expires = \"\";\n      if (days) {\n        var date = new Date();\n        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n        expires = \"; expires=\" + date.toGMTString();\n      }\n      document.cookie = name + \"=\" + value + expires + '; path=/';\n    },\n\n    readAll: function readCookies() {\n      if (document.cookie === '') return {};\n      var cookies = document.cookie.split('; ')\n        , result = {};\n      for (var i = 0, l = cookies.length; i < l; i++) {\n        var item = cookies[i].split('=');\n        result[decodeURIComponent(item[0])] = decodeURIComponent(item[1]);\n      }\n      return result;\n    },\n\n    read: function readCookie(name) {\n      return cookie.readAll()[name];\n    },\n\n    erase: function eraseCookie(name) {\n      cookie.create(name, \"\", -1);\n    }\n  };\n\n  //goes up the DOM tree (including given element) until it finds an element that matches the nodeName\n  var closestHrefParent = function (elem) {\n    while (elem != null) {\n      if (elem.nodeType === 1 && (elem.href || elem.getAttribute('href'))) {\n        return elem;\n      }\n      elem = elem.parentNode;\n    }\n    return null;\n  };\n\n  global.Puppet = Puppet;\n})(window);\n"]}