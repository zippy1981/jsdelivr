/*! taucharts - v0.2.20 - 2014-12-18
* https://github.com/TargetProcess/tauCharts
* Copyright (c) 2014 Taucraft Limited; Licensed Creative Commons */
!function(a){if("function"==typeof define&&define.amd)define(["tauCharts"],function(b){return a(b)});else if("object"==typeof module&&module.exports){{require("tauCharts")}module.exports=a()}else a(this.tauCharts)}(function(a){function b(a){var b=d.defaults(a||{},{type:"linear",showPanel:!0,showTrend:!0});return{init:function(a){this._chart=a,b.showPanel&&(this._container=a.insertToRightSidebar(this.containerTemplate),this.hasError=!1,this.uiChangeEventsDispatcher=function(a){var c=a.target,d=c.classList;d.contains("i-role-show-trend")&&(b.showTrend=c.checked),d.contains("i-role-change-model")&&(b.type=c.value),this._chart.refresh()}.bind(this),this._container.addEventListener("change",this.uiChangeEventsDispatcher,!1))},onUnitReady:function(a,i){if(b.showTrend&&h(i)){if(!g(i))return this.error="Trend line can't be computed for categorical data. Each axis should be either a measure or a date.",void(this.hasError=!0);var j=i.options,k=i.x.scaleDim,l=i.y.scaleDim,m=i.color.scaleDim,n=i.groupBy(i.partition(),m);n.forEach(function(a,e){var g=a.key,h=a.values,i=h.map(function(a){var b=d.isDate(a[k])?a[k].getTime():a[k],c=d.isDate(a[l])?a[l].getTime():a[l];return[b,c]}),m=c(b.type,i),n=d.sortBy(m.points,function(a){return a[0]});n.length>1&&f("i-trendline-"+e,n,m.string,j.xScale,j.yScale,j.color.get(g),j.container)});var o=function(a){return function(){var b=e.mouse(this),c=e.select(this);c.classed({active:a,"graphical-report__line-width-1":!a,"graphical-report__line-width-2":a}),c.select(".graphical-report__trendline__tip").attr("x",b[0]+3).attr("y",b[1]-3)}};j.container.selectAll(".graphical-report__trendline").on("mouseenter",o(!0)).on("mouseleave",o(!1))}},containerTemplate:'<div class="graphical-report__trendlinepanel"></div>',template:d.template(['<label class="graphical-report__trendlinepanel__title graphical-report__checkbox">','<input type="checkbox" class="graphical-report__checkbox__input i-role-show-trend <%= hideControls %>" <%= showTrend %> />','<span class="graphical-report__checkbox__icon <%= hideControls %>"></span>','<span class="graphical-report__checkbox__text">',"<%= title %>","</span>","</label>","<div>",'<select class="i-role-change-model graphical-report__select graphical-report__trendlinepanel__control <%= hideControls %>">',"<%= models %> />","</select>","</div>",'<div class="graphical-report__trendlinepanel__error-message"><%= error %></div>',"</div>"].join("")),onRender:function(){this._container&&(this._container.innerHTML=this.template({title:"Trend line",showTrend:b.showTrend&&!this.hasError?"checked":"",models:["linear","exponential","logarithmic"].map(function(a){var c=b.type===a?"selected":"";return"<option "+c+' value="'+a+'">'+a+"</option>"}),error:this.error,hideControls:this.hasError?"graphical-report__trendlinepanel__hide":""}))}}}var c=function(){"use strict";var a=function(a,b){var c=0,d=0,e=0,f=0,g=0,h=a.length-1,i=new Array(b);for(c=0;h>c;c++){for(f=c,d=c+1;h>d;d++)Math.abs(a[c][d])>Math.abs(a[c][f])&&(f=d);for(e=c;h+1>e;e++)g=a[e][c],a[e][c]=a[e][f],a[e][f]=g;for(d=c+1;h>d;d++)for(e=h;e>=c;e--)a[e][d]-=a[e][c]*a[c][d]/a[c][c]}for(d=h-1;d>=0;d--){for(g=0,e=d+1;h>e;e++)g+=a[e][d]*i[e];i[d]=(a[h][d]-g)/a[d][d]}return i},b={linear:function(a){for(var b=[0,0,0,0,0],c=0,d=[];c<a.length;c++)a[c][1]&&(b[0]+=a[c][0],b[1]+=a[c][1],b[2]+=a[c][0]*a[c][0],b[3]+=a[c][0]*a[c][1],b[4]+=a[c][1]*a[c][1]);var e=(c*b[3]-b[0]*b[1])/(c*b[2]-b[0]*b[0]);e=isNaN(e)?0:e;for(var f=b[1]/c-e*b[0]/c,g=0,h=a.length;h>g;g++){var i=[a[g][0],a[g][0]*e+f];d.push(i)}var j="y = "+Math.round(100*e)/100+"x + "+Math.round(100*f)/100;return{equation:[e,f],points:d,string:j}},exponential:function(a){var b=[0,0,0,0,0,0],c=0,d=[];for(i=a.length;i>c;c++)a[c][1]&&(b[0]+=a[c][0],b[1]+=a[c][1],b[2]+=a[c][0]*a[c][0]*a[c][1],b[3]+=a[c][1]*Math.log(a[c][1]),b[4]+=a[c][0]*a[c][1]*Math.log(a[c][1]),b[5]+=a[c][0]*a[c][1]);for(var e=b[1]*b[2]-b[5]*b[5],f=Math.pow(Math.E,(b[2]*b[3]-b[5]*b[4])/e),g=(b[1]*b[4]-b[5]*b[3])/e,h=0,i=a.length;i>h;h++){var j=[a[h][0],f*Math.pow(Math.E,g*a[h][0])];d.push(j)}var k="y = "+Math.round(100*f)/100+"e^("+Math.round(100*g)/100+"x)";return{equation:[f,g],points:d,string:k}},logarithmic:function(a){var b=[0,0,0,0],c=0,d=[];for(h=a.length;h>c;c++)a[c][1]&&(b[0]+=Math.log(a[c][0]),b[1]+=a[c][1]*Math.log(a[c][0]),b[2]+=a[c][1],b[3]+=Math.pow(Math.log(a[c][0]),2));for(var e=(c*b[1]-b[2]*b[0])/(c*b[3]-b[0]*b[0]),f=(b[2]-e*b[0])/c,g=0,h=a.length;h>g;g++){var i=[a[g][0],f+e*Math.log(a[g][0])];d.push(i)}var j="y = "+Math.round(100*f)/100+" + "+Math.round(100*e)/100+" ln(x)";return{equation:[f,e],points:d,string:j}},power:function(a){var b=[0,0,0,0],c=0,d=[];for(h=a.length;h>c;c++)a[c][1]&&(b[0]+=Math.log(a[c][0]),b[1]+=Math.log(a[c][1])*Math.log(a[c][0]),b[2]+=Math.log(a[c][1]),b[3]+=Math.pow(Math.log(a[c][0]),2));for(var e=(c*b[1]-b[2]*b[0])/(c*b[3]-b[0]*b[0]),f=Math.pow(Math.E,(b[2]-e*b[0])/c),g=0,h=a.length;h>g;g++){var i=[a[g][0],f*Math.pow(a[g][0],e)];d.push(i)}var j="y = "+Math.round(100*f)/100+"x^"+Math.round(100*e)/100;return{equation:[f,e],points:d,string:j}},polynomial:function(b,c){"undefined"==typeof c&&(c=2);for(var d=[],e=[],f=[],g=0,h=0,i=0,j=c+1;j>i;i++){for(var k=0,l=b.length;l>k;k++)b[k][1]&&(g+=Math.pow(b[k][0],i)*b[k][1]);d.push(g),g=0;for(var m=[],n=0;j>n;n++){for(var k=0,l=b.length;l>k;k++)b[k][1]&&(h+=Math.pow(b[k][0],i+n));m.push(h),h=0}e.push(m)}e.push(d);for(var o=a(e,j),i=0,l=b.length;l>i;i++){for(var p=0,q=0;q<o.length;q++)p+=o[q]*Math.pow(b[i][0],q);f.push([b[i][0],p])}for(var r="y = ",i=o.length-1;i>=0;i--)r+=i>1?Math.round(100*o[i])/100+"x^"+i+" + ":1==i?Math.round(100*o[i])/100+"x + ":Math.round(100*o[i])/100;return{equation:o,points:f,string:r}},lastvalue:function(a){for(var b=[],c=null,d=0;d<a.length;d++)a[d][1]?(c=a[d][1],b.push([a[d][0],a[d][1]])):b.push([a[d][0],c]);return{equation:[c],points:b,string:""+c}}};return function(a,c,d){return"string"==typeof a?b[a](c,d):void 0}}(),d=a.api._,e=a.api.d3,f=function(a,b,c,d,f,g,h){var i=["graphical-report__trendline","graphical-report__line-width-1","graphical-report__line-opacity-1",a,g].join(" "),j=e.svg.line().x(function(a){return d(a[0])}).y(function(a){return f(a[1])}),k=function(){this.attr("d",j)},l=function(){this.attr("class",i);var a=this.selectAll(".graphical-report__trendline__tip");a.remove(),this.append("text").attr("class","graphical-report__trendline__tip").text(c);var b=this.selectAll("path").data(function(a){return[a]});b.call(k),b.enter().append("path").call(k),b.exit().remove()},m=h.selectAll("."+a).data([b]);m.call(l),m.enter().append("g").call(l),m.exit().remove()},g=function(a){var b=a.type&&0===a.type.indexOf("ELEMENT.");if(!b)return!1;var c=a.x.dimType,e=a.y.dimType;return d.every([c,e],function(a){return a&&"category"!=a})},h=function(a){return a.type&&0===a.type.indexOf("ELEMENT.")};return a.api.plugins.add("trendline",b),b});