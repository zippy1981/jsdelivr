/*! taucharts - v0.2.21 - 2014-12-18
* https://github.com/TargetProcess/tauCharts
* Copyright (c) 2014 Taucraft Limited; Licensed Creative Commons */
!function(a){if("function"==typeof define&&define.amd)define(["tauCharts"],function(b){return a(b)});else if("object"==typeof module&&module.exports){{require("tauCharts")}module.exports=a()}else a(this.tauCharts)}(function(a){function b(a){return a=a||{},{template:['<div class="i-role-content graphical-report__tooltip__content"></div>','<div class="i-role-exclude graphical-report__tooltip__exclude"><span class="tau-icon-close-gray"></span>Exclude</div>'].join(""),itemTemplate:['<div class="graphical-report__tooltip__list__item">','<div class="graphical-report__tooltip__list__elem"><%=label%></div>','<div class="graphical-report__tooltip__list__elem"><%=value%></div>',"</div>"].join(""),onExcludeData:function(){},_drawPoint:function(a,b,c,d){this.circle&&this.circle.remove(),this.circle=a.append("circle").attr("cx",b).attr("cy",c).attr("class",d).attr("r",4),this.circle.node().addEventListener("mouseover",function(){clearTimeout(this._timeoutHideId)}.bind(this),!1),this.circle.node().addEventListener("mouseleave",function(){this._hide()}.bind(this),!1)},formatters:{},_getFormatter:function(a){return this.formatters[a]||c.identity},init:function(b){this._chart=b,this._dataFields=a.fields,c.extend(this,c.omit(a,"fields")),this._timeoutHideId=null,this._dataWithCoords={},this._unitMeta={},this._templateItem=c.template(this.itemTemplate),this._tooltip=b.addBalloon({spacing:3,auto:!0,effectClass:"fade"}),this._elementTooltip=this._tooltip.getElement();var d=this._elementTooltip;d.addEventListener("mouseover",function(){clearTimeout(this._timeoutHideId)}.bind(this),!1),d.addEventListener("mouseleave",function(){this._hide()}.bind(this),!1),d.addEventListener("click",function(a){var b=a.target;b.classList.contains("i-role-exclude")&&(this._exclude(),this._hide())}.bind(this),!1),d.insertAdjacentHTML("afterbegin",this.template)},onUnitReady:function(a,b){if(b.type&&0===b.type.indexOf("ELEMENT")){var c=this._generateKey(b.$where);this._unitMeta[c]=b;var d=b.partition();this._dataWithCoords[c]=d.map(function(a){return{x:b.options.xScale(a[b.x.scaleDim]),y:b.options.yScale(a[b.y.scaleDim]),item:a}},this)}},render:function(a,b){return b=c.unique(b),b.map(function(b){var d=a[b],e=c.isNull(d)||c.isUndefined(d)?"No "+b:d;return this._templateItem({label:b,value:this._getFormatter(b)(e)})},this).join("")},onRender:function(){this._hide()},_exclude:function(){this._chart.addFilter({tag:"exclude",predicate:function(a){return function(b){return JSON.stringify(b)!==JSON.stringify(a)}}(this._currentElement)}),this.onExcludeData(this._currentElement)},_calculateLength:function(a,b,c,d){return(c-a)*(c-a)+(d-b)*(d-b)},_calculateLengthToLine:function(a,b,c,d,f,g){var h={x:c-a,y:d-b},i={x:f-a,y:g-b},j=h.x*i.x+h.y*i.y;if(0>j)return e(a,f,b,g);var k={x:a-c,y:b-d},l={x:f-c,y:g-d},m=k.x*l.x+k.y*l.y;return 0>m?e(c,f,d,g):Math.abs(((c-a)*(g-b)-(d-b)*(f-a))/e(a,c,b,d))},_generateKey:function(a){return JSON.stringify(a)},_getFields:function(a){if(this._dataFields)return this._dataFields;for(var b=[a.size&&a.size.scaleDim,a.color&&a.color.scaleDim],d=[],e=[];a=a.parentUnit;)d.push(a.x.scaleDim),e.push(a.y.scaleDim);return c.compact(b.concat(e,d).reverse())},isLine:function(a){return a.elementData.key&&Array.isArray(a.elementData.values)},_onElementMouseOver:function(a,b,e,f){clearTimeout(this._timeoutHideId);var g=this._generateKey(b.cellData.$where),h=b.elementData,i=this.isLine(b);if(i){var j=this._dataWithCoords[g],k=j.filter(function(a){return c.contains(h.values,a.item)}),l=c.reduce(k,function(a,b,c,d){var f;if(c+1===d.length){var g=b;b=d[c-1],f=g}else f=d[c+1];var h=this._calculateLengthToLine(b.x,b.y,f.x,f.y,e[0],e[1]);return h<a.h&&(a.h=h,a.points={point1:b,point2:f}),a}.bind(this),{h:1/0,points:{}}),m=c.min(l.points,function(a){return this._calculateLength(a.x,a.y,e[0],e[1])},this);h=m.item,this._drawPoint(d.select(b.element.parentNode),m.x,m.y,this._unitMeta[g].options.color.get(b.elementData.key))}if(this._currentElement!==h){var n=this._elementTooltip.querySelectorAll(".i-role-content");if(n[0]){var o=this._getFields(this._unitMeta[g]);n[0].innerHTML=this.render(h,o)}else console.log("template should contain i-role-content class");this._show(f),this._currentElement=h}},onElementMouseOver:function(a,b){var e=d.mouse(document.body),f=d.mouse(b.element);clearTimeout(this._timeoutShowId),this._timeoutShowId=c.delay(this._onElementMouseOver.bind(this),200,a,b,f,e)},onElementMouseOut:function(){this._hide()},_show:function(a){this._tooltip.show(a[0],a[1]).updateSize()},_hide:function(){clearTimeout(this._timeoutShowId),this._timeoutHideId=setTimeout(function(){this._currentElement=null,this._tooltip.hide(),this.circle&&this.circle.remove()}.bind(this),300)},_destroyTooltip:function(){this.circle&&this.circle.remove(),this._tooltip.destroy()},destroy:function(){this._destroyTooltip()}}}var c=a.api._,d=a.api.d3,e=function(a,b,c,d){return Math.sqrt((b-a)*(b-a)+(d-c)*(d-c))};return a.api.plugins.add("tooltip",b),b});