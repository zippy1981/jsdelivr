/*! tauCharts - v0.2.4 - 2014-12-10
* https://github.com/TargetProcess/tauCharts
* Copyright (c) 2014 Taucraft Limited; Licensed Creative Commons */
!function(a){if("function"==typeof define&&define.amd)define(["tauCharts"],function(b){return a(b)});else if("object"==typeof module&&module.exports){{require("tauCharts")}module.exports=a()}else a(this.tauCharts)}(function(a){function b(a){return a=a||{},{template:['<div class="i-role-content graphical-report__tooltip__content"></div>','<div class="i-role-exclude graphical-report__tooltip__exclude"><span class="tau-icon-close-gray"></span>Exclude</div>'].join(""),itemTemplate:['<div class="graphical-report__tooltip__list__item">','<div class="graphical-report__tooltip__list__elem"><%=label%></div>','<div class="graphical-report__tooltip__list__elem"><%=value%></div>',"</div>"].join(""),onExcludeData:function(){},_drawPoint:function(a,b,c,d){this.circle&&this.circle.remove(),this.circle=a.append("circle").attr("cx",b).attr("cy",c).attr("class",d).attr("r",4),this.circle.node().addEventListener("mouseover",function(){clearTimeout(this._interval)}.bind(this),!1),this.circle.node().addEventListener("mouseleave",function(){this._hide()}.bind(this),!1)},init:function(b){this._chart=b,this._dataFields=a.fields,c.extend(this,c.omit(a,"fields")),this._interval=null,this._dataWithCoords={},this._unitMeta={},this._templateItem=c.template(this.itemTemplate),this._tooltip=b.addBalloon({spacing:5,auto:!0}),this._elementTooltip=this._tooltip.getElement();var d=this._elementTooltip;d.addEventListener("mouseover",function(){clearTimeout(this._interval)}.bind(this),!1),d.addEventListener("mouseleave",function(){this._hide()}.bind(this),!1),d.addEventListener("click",function(a){var b=a.target;b.classList.contains("i-role-exclude")&&(this._exclude(),this._hide())}.bind(this),!1),d.insertAdjacentHTML("afterbegin",this.template)},onUnitReady:function(a,b){if(b.type&&0===b.type.indexOf("ELEMENT")){var c=this._generateKey(b.$where);this._unitMeta[c]=b;var d=b.partition();this._dataWithCoords[c]=d.map(function(a){return{x:b.options.xScale(a[b.x.scaleDim]),y:b.options.yScale(a[b.y.scaleDim]),item:a}},this)}},render:function(a,b){return b.map(function(b){var d=a[b],e=c.isNull(d)||c.isUndefined(d)?"No "+b:d;return this._templateItem({label:b,value:e})},this).join("")},_exclude:function(){var a=this._chart.getData();this._chart.setData(c.without(a,this._currentElement)),this.onExcludeData(this._currentElement)},_calculateLength:function(a,b,c,d){return(c-a)*(c-a)+(d-b)*(d-b)},_generateKey:function(a){return JSON.stringify(a)},_getFields:function(a){if(this._dataFields)return this._dataFields;for(var b=[a.size.scaleDim,a.color.scaleDim],d=[],e=[];a=a.parentUnit;)d.push(a.x.scaleDim),e.push(a.y.scaleDim);return c.compact(b.concat(e,d).reverse())},isLine:function(a){return a.elementData.key&&Array.isArray(a.elementData.values)},onElementMouseOver:function(a,b){clearInterval(this._interval);var e=this._generateKey(b.cellData.$where),f=d.mouse(b.element),g=b.elementData,h=this.isLine(b);if(h){var i=this._dataWithCoords[e],j=i.filter(function(a){return c.contains(g.values,a.item)}),k=c.min(j,function(a){return this._calculateLength(a.x,a.y,f[0],f[1])},this);g=k.item,this._drawPoint(d.select(b.element.parentNode),k.x,k.y,this._unitMeta[e].options.color.get(b.elementData.key))}if(this._currentElement!==g){var l=this._elementTooltip.querySelectorAll(".i-role-content");if(l[0]){var m=this._getFields(this._unitMeta[e]);l[0].innerHTML=this.render(g,m)}else console.log("template should contain i-role-content class");this._show(),this._currentElement=g}},onElementMouseOut:function(){this._hide()},_show:function(){this._tooltip.show();var a=d.mouse(this._elementTooltip.parentNode);this._tooltip.position(a[0],a[1]).updateSize()},_hide:function(){this._interval=setTimeout(function(){this._currentElement=null,this._tooltip.hide(),this.circle&&this.circle.remove()}.bind(this),300)},_destroyTooltip:function(){this.circle&&this.circle.remove(),this._tooltip.destroy()},destroy:function(){this._destroyTooltip()}}}var c=a.api._,d=a.api.d3;return a.api.plugins.add("tooltip",b),b});