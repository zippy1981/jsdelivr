/*!
 * jQuery Mobile Editable Listview Plugin
 * https://github.com/baig/jquerymobile-editablelistview
 *
 * Copyright 2014 (c) Wasif Hasan Baig
 *
 * Released under the MIT license
 * https://github.com/baig/jquerymobile-editablelistview/blob/master/LICENSE.txt
 */
!function(t,e){"use strict";t.widget("mobile.listview",t.mobile.listview,{_created:!1,_origDom:null,_editMode:!1,_counter:1,_dataItemName:"item",_evt:null,_clickHandler:null,_tapHandler:null,options:{editable:!1,editableType:"simple",editableForm:"",itemName:"",title:"View list items",emptyTitle:"No items to view",editLabel:"Edit",addLabel:"Add",doneLabel:"Done",addIcon:"plus",editIcon:"edit",doneIcon:"check",buttonTheme:"a",buttonCorner:!0,buttonShadow:!0,itemIcon:!1,collapsed:!1,expandedIcon:"carat-d",collapsedIcon:"carat-r"},_beforeListviewRefresh:function(){if(this.options.editable){var e,i,n=this.element,a=this.options,l=this._origDom,s=this._dataItemName,o=this._counter,d={},r=this._evt,h=n.find("li"),u=this._$markup;this._created||(n.find("li").not("li.ui-editable-temp").length!==(null===l?-1:l.find("li").length)&&(l=n.clone(),t.each(l.children("li"),function(e,i){t(i).attr("data-"+s,o),o++}),this._counter=o,this._origDom=this._getUnenhancedList(l)),d.wrapper=this._wrapCollapsible(),d.header=d.wrapper.find(".ui-collapsible-heading"),d.button=d.header.find("a a, a button"),d.content=d.wrapper.find(".ui-collapsible-content"),d.form=this._getForm(),t.extend(this,{_ui:d,_newItems:[],_items:{}}),this._items=this._getExistingListContents(),r=this._evt=t._data(d.header[0],"events"),this._clickHandler=r.click[0].handler,this._tapHandler=r.tap[0].handler,this._attachEditEventButtons(),this._created=!0),this._editMode?(d=this._ui,e=l.clone(),i=e.find("li"),0===e.find("li.ui-editable-temp").length&&(0===e.find("a").length&&i.wrapInner("<a></a>"),i.append('<a class="ui-editable-btn-del">Delete</a>'),this.option("splitIcon","minus"),"complex"===a.editableType&&(e.prepend('<li class="ui-editable-temp"></li>'),e.find("li.ui-editable-temp").append(d.form)),"simple"===a.editableType&&e.prepend(u.listTextInput)),h.remove(),n.append(e.find("li")),r.click[0].handler=r.tap[0].handler=t.noop):(r.click[0].handler=this._clickHandler,r.tap[0].handler=this._tapHandler,h.filter(".ui-editable-temp").hide(),h.not(".ui-editable-temp").remove(),n.append(a.itemIcon?l.clone().find("li"):l.clone().find("li").attr("data-icon","false"))),this._updateHeader()}},_getExistingListContents:function(){var i=this.options,n=this._ui,a=(this._origDom,{}),l={};return"simple"===this.options.editableType&&this._origDom.find("li").each(function(e,i){var n=t(i);a[n.data("item")]=n.text()}),"complex"===i.editableType&&(n.form.find("input").each(function(e,i){var n=t(i).data("item-name");l[n]=n}),this._origDom.find("li").each(function(i,n){var s=t(n),o=(s.html(),{});t.each(l,function(t){var i=s.find("span#"+t),n=i.data("value");o[t]=n!==e?n:i.text()}),a[s.data("item")]=o})),a},_getForm:function(){var t=this.element,e=this.options,i=this._ui,n=null;if("complex"===e.editableType){if(i&&i.form)return i.form;try{if(0===e.editableForm.length)throw new Error("Form not specified for the Complex Editable Listview type.");if(n=t.closest(':jqmData(role="page")').find("#"+e.editableForm),!n.length)throw new Error("No form found. Specify a form.");if(!n.is("form, div")&&!n.attr("data-editable-form"))throw new Error('In case of Complex Editable type, the form\'s id should match the "data-editable-form" attribute on ul tag, and the form element itself should have data-editable-form="true" attribute.');n=n.detach()}catch(a){console.error(a.message)}}return n},_getUnenhancedList:function(t){return t.removeClass("ui-listview ui-shadow ui-corner-all ui-listview-inset ui-group-theme-"+this.options.theme).find("li").removeClass("ui-li-static ui-body-inherit ui-first-child ui-last-child ui-li-has-alt").end().find("a").removeClass("ui-link").end()},_afterListviewRefresh:function(){this.options.editable&&this._attachDetachEventHandlers()},_wrapCollapsible:function(){var t=this.element;return t.wrap("<div data-role='collapsible'></div>").before(this._$markup.header(this.options,this._isListEmpty())),t.closest(":jqmData(role='collapsible')").collapsible()},_attachEditEventButtons:function(){this._isListEmpty()&&this._ui.header.off("click"),this._on(this._ui.button,{click:"_onEditButtonTapped"})},_onEditButtonTapped:function(t){t.preventDefault(),t.stopPropagation();var e=this._editMode=!this._editMode,i=this.element.parents(":jqmData(role='collapsible')");i.collapsible(e?"expand":"collapse"),this.refresh(),e||this._triggerListChange(t)},_updateHeader:function(){var t=this._ui,e=this.options,i=this._isListEmpty();t.header.children("a")[0].childNodes[0].data=i?e.emptyTitle:e.title,t.button.removeClass("ui-icon-minus ui-icon-"+e.doneIcon+" ui-icon-"+e.addIcon+" ui-icon-"+e.editIcon).addClass("ui-icon-"+(this._editMode?e.doneIcon:i?e.addIcon:e.editIcon)).text(this._editMode?e.doneLabel:i?e.addLabel:e.editLabel)},_triggerListChange:function(t){var e=this.options;this._trigger("change",t,{items:"simple"===e.editableType&&""!==e.itemName?this._toObjectCollection(this._toArray(this._items),e.itemName):this._toArray(this._items),added:"simple"===e.editableType&&""!==e.itemName?this._toObjectCollection(this._newItems,e.itemName):this._newItems,length:this.length()}),this._newItems=[]},_attachDetachEventHandlers:function(){this._enableInsertListItemEvent(),this._enableListItemDeleteEvent()},_enableInsertListItemEvent:function(){var t,e,i,n=this.options,a=n.editableType,l=this._ui.content;this._editMode&&(t=l.find("simple"===a?"li.ui-editable-temp a#item-add":"li:first-child [data-add-button='true']"),e="complex"===a?l.find("li:first-child [data-clear-button='true']"):null,i="simple"===a?l.find("input[type=text]"):null,this._off(t,"tap"),this._on(t,{tap:"_insertListItem"}),null!==e&&(this._off(e,"tap"),this._on(e,{tap:"_clearTextFields"})),null!==i&&(this._off(i,"keyup"),this._on(i,{keyup:"_insertListItem"})))},_clearTextFields:function(e){e.preventDefault();var i=t(e.target).parents("li").find("[data-item-name]");t.each(i,function(e,i){t(i).val("")})},_enableListItemDeleteEvent:function(){this._editMode?this._on(this._ui.content.find("a.ui-editable-btn-del"),{click:"_deleteListItem"}):this._off(this._ui.content.find("a.ui-editable-btn-del"),"click")},_insertListItem:function(e){e.preventDefault();var i=this.element,n={};if("tap"===e.type||e.keyCode===t.mobile.keyCode.ENTER){if("complex"===this.options.editableType){var a="",l=!0,s=t(e.target).parents("li").find("[data-item-name]");if(t.each(s,function(e,s){var o=t(s),d=o.data("item-template"),r=o.attr("type"),h=o.data("item-name"),u=null;switch(r){case"text":case"number":u=o.val(),n[h]=u,o.val("");break;case"checkbox":u=o.is(":checked"),n[h]=u;break;case"radio":var h=o.attr("name"),c=i.find("li:first-child input[data-item-name='"+h+"']").filter(":radio");c.each(function(){var e=t(this);e.is(":checked")&&(u=e.data("item-display-value"),n[h]=e.val())})}u||"checkbox"===r||(l=!1);var m=d.replace(/%%/,u);a+=-1===a.indexOf(m)?m:""}),!l)return;var o=this._counter;this._counter++,this._newItems.push(n),this._items[o]=n,a=t("<li><a>"+a+"</a></li>"),a.attr("data-"+this._dataItemName,o),this._origDom.prepend(a),this.refresh()}if("simple"===this.options.editableType){var d=t(e.target),r="keyup"===e.type?d:d.prev().find("input"),h=r.val();if(h){r.val("");var o=this._counter;this._counter++,this._newItems.push(h),this._items[o]=h;var a=this._isListEmpty()?t("<li></li>"):this._origDom.find("li").first().clone();a.attr("data-"+this._dataItemName,o),0===a.children().length?a.text(h):a.children("a").text(h),this._origDom.prepend(a),this.refresh()}}}},_deleteListItem:function(e){e.preventDefault(),e.stopPropagation();var i=t(e.currentTarget).parent(),n=i.data(this._dataItemName);this._origDom.find("li[data-"+this._dataItemName+'="'+n+'"]').remove(),delete this._items[n],i.remove(),this._updateHeader()},_isListEmpty:function(){return 0===this.element.find("li").not("li.ui-editable-temp").length?!0:!1},_$markup:{header:function(t){return"<h1>"+t.title+"<button class='ui-btn ui-mini ui-btn-inline ui-btn-right ui-btn-icon-right ui-icon-"+t.editIcon+" ui-btn-"+t.buttonTheme+(t.buttonCorner?" ui-corner-all":"")+(t.buttonShadow?" ui-shadow":"")+"'>"+t.editLabel+"</button></h1>"},listTextInput:"<li class='ui-editable-temp ui-btn' style='padding: 0.3em 0.8em;'><div class='ui-editable-flex'><div style='background-color: white; padding: 0;' class='ui-editable-flex-item-left ui-editable-border-left ui-input-text ui-btn ui-shadow-inset'><input type='text'></div><a id='item-add' style='height: auto' class='ui-editable-flex-item-right ui-editable-border-right ui-btn ui-shadow ui-btn-icon-notext ui-icon-plus'>Add</a></div></li>"},_toArray:function(t){for(var e=[],i=Object.keys(t),n=0;n<i.length;n++)e.push(t[i[n]]);return e},_toObjectCollection:function(t,e){for(var i=[],n=0;n<t.length;n++){var a={};a[e]=t[n],i.push(a)}return i},length:function(){return this.element.find("li").not(".ui-editable-temp").length},items:function(){return JSON.parse(JSON.stringify(this._items))},widget:function(){return this._ui.wrapper}})}(jQuery);